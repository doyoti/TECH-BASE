<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>mission_3-5</title>
</head>
<body>
    <?php
    error_reporting(E_ALL & ~E_NOTICE);  //phpのエラーを非表示にする
    $filename="mission_3-5.txt";
    
    $date = date("Y年m月d日 H時i分s秒");   //投稿日時
    
    $name = $_POST["name"];                //名前
    $comment = $_POST["comment"];          //コメント
    
    $edit1 = $_POST["edit1"];
    $edit2 = $_POST["edit2"];            //編集対象番号
    
    $delete = $_POST["delete"];            //削除対象番号
    
    $password1 = $_POST["password1"];
    $password2 = $_POST["password2"];
    $password3 = $_POST["password3"];
    
    //新規投稿

    //$name=$_POST["name"];と$comment=$_POST["comment"];は、if(isset($name) && isset($comment))より前に書かないと、if以下が実行されなくなる。
    
    if(!empty($name) && !empty($comment) && empty($edit1)) {  //新規投稿は編集対象番号が空
    
        if(!empty($password1)){
            $fp = fopen($filename,"a");
            
            if(file_exists($filename)){
            $lines = file($filename,FILE_IGNORE_NEW_LINES);
            foreach($lines as $line){
            $str = explode("<>", $line);
                $a = $str[0];
                $b = $str[1];
                $c = $str[2];
                $d = $str[3];
            }
        }
    
        if(empty($lines)){
            $n = 1;
        }
        else{
            $n = $a +1;
        }
            
            fwrite($fp, $n."<>".$name."<>".$comment."<>".$date."<>".$password1."<>".PHP_EOL);  //書き込み部分
            
            fclose($fp);
        }
        else{
            echo "パスワードを入力してください。"."<br>";
        }
    }
    
    
    //編集
    
    //編集での場合分け
    //1⃣パスワードがある
        //⑴番号が一致
            //①if(パスワードが一致)　これが編集できるやつ
            //②elseif(パスワードが一致していない)　echo パスワードが違います
            
        //⑵番号が一致しない
            //Echo 投稿番号が違います←これは表示されるものが多すぎるからいちいち書かない。
            
    //2⃣パスワードがない→echo パスワードを入力してください

    
    if(!empty($edit2)){
        
        //番号は固定できてないから、パスワードの一致と番号の一致両方考える
        if(!empty($password3)){
                
            $lines = file($filename,FILE_IGNORE_NEW_LINES);  //配列を定義する
            foreach($lines as $line){        //配列を変数に
                $str = explode("<>",$line);  //line=str[0]<>str[1]<>str[2]<>str[3] を<>で分割してstr[0], str[1], str[2], str[3]にバラす。
                                         //str[0]=投稿番号、str[1]=名前、str[2]=コメント、str[3]=投稿日時
                                         
                if($edit2 == $str[0]){     //これが編集できるやつ、edit2に入力された番号と投稿番号が同じとき
                    
                    if($password3 == $str[4]){           //ここにある、&str[]のデータは新規投稿の時のもの。
                        $i = $str[1];  //名前
                        $j = $str[2];  //コメント
                        $k = $str[0];  //投稿番号
                        $l = $str[4];  //パスワード      //したがって、このパスワードは新規投稿の時のものであり、これを入力欄に表示させることで、新規投稿の時のパスワードをそのまま表示させることができる。
                    }
                    
                    elseif($password3 != $str[4]){
                        echo "パスワードが違います。";
                    }
                }
            }
        }
        elseif(empty($password3)){
            echo "パスワードを入力してください。";
        }
        
    }

    ?>
    
        <form action="" method="post">
        <input type="text" name="name" placeholder="名前" value = "<?php if(isset($edit2)) {echo $i;} ?>"><br>
        <input type="text" name="comment" placeholder="コメント" value = "<?php if(isset($edit2)) {echo $j;} ?>"><br>
        <input type="text" name="password1" placeholder="パスワード" value = "<?php if(isset($edit2)) {echo $l;} ?>"><br>
        <input type="hidden" name="edit1" placeholder="編集対象番号" value = "<?php if(isset($edit2)) {echo $k;} ?>">
        <input type="submit" name="submit" value = "投稿"><br><br>
        <input type="number" name="delete" placeholder="削除対象番号"><br>
        <input type="text" name="password2" placeholder="パスワード"><br>
        <input type="submit" name="submit" value = "削除"><br><br>
        <input type="number" name="edit2" placeholder="編集対象番号"><br>
        <input type="text" name="password3" placeholder="パスワード"><br>
        <input type="submit" name="submit" value = "編集"><br>
        
    </form>
    <?php
    

    
    //編集
    
    if(!empty($name) && !empty($comment) && !empty($edit1)) {  //編集では編集対象番号が埋まっている
        
            $lines = file($filename, FILE_IGNORE_NEW_LINES);
            $fp = fopen($filename, "w");
            fclose($fp);
            $fp = fopen($filename, "a");
            
            foreach($lines as $line){
            $str = explode("<>", $line);
            
            if($edit1 == $str[0]){            //編集対象番号欄に入力した番号と投稿番号が等しいとき
                fwrite($fp, $edit1."<>".$name."<>".$comment."<>".$date."<>".$password1."<>".PHP_EOL);    //edit1に入力された番号が投稿番号、nameされたものが名前、commentに入力されたものがコメント、日付は最新のもの
            }
            else{
                fwrite($fp, $line.PHP_EOL);   //$line = $a."<>".$b."<>".$c."<>".$d = $str[0]."<>".$str[1]."<>".$str[2]."<>".$str[3]
                                              //ただし、ここでは $a, $b, $c, $d を定義していないので、$str[1]を使う。
                                              //ここでは、編集対象番号欄に入力した番号と投稿番号が等しくないとき、元々の新規投稿のときのデータをそのまま表示している。
            }
            }
            
            fclose($fp);
    }
    
    //削除処理
    
    //削除処理での場合分け
    //1⃣if(パスワードがある)
        //(1)If(削除番号と投稿番号が一致)
            //①	if(パスワード一致)→これだけ消える
            //②	if(パスワードが一致しない)→消えない
            
        //(2)	elseif(削除番号と投稿番号が一致しない)→消えない
        
    //2⃣elseif(パスワードがない)→消えない

    
    if(!empty($delete)) {
        
        if(!empty($password2)){
            $lines = file($filename,FILE_IGNORE_NEW_LINES);  //配列を定義
            
            $fp = fopen($filename, "w");           //wで開くのは、今までのtxtデータを一回まっさらな状態にして、新たに該当する番号以外を書き込むため。
                                               //wで一回まっさらにする。wのまま書き込むと、一行書いて、さらに一行書こうとするとまたまっさらな状態になる。
                                               //なぜなら、一気にデータを書いているわけではなく、一行ごとに処理を行っているので。
            fclose($fp);                           //一回閉じる
            
            //ここに「58行目で取得した削除対象番号」以外の番号のものを表示するプログラムを書きたい。
            
            $fp = fopen($filename, "a");           //aで開きなおす
            
            foreach($lines as $line){              //配列を変数に
                $str = explode("<>", $line);       //変数を<>で分割
                
                $a = $str[0];
                $b = $str[1];
                $c = $str[2];
                $d = $str[3];
                $e = $str[4];
                
                if($delete == $a){   //削除対象番号と投稿番号が同じとき、
                    if($password2 == $str[4]){    //パスワード2と新規作成のときのパスワードが同じときだけ、書き込まない。(fwriteがないので)→このときは書き込まないが、それは一個だけで、ほかの列は別の条件のところに入って、書き込まれる。
                        
                    }
                    
                    elseif($password2 != $str[4]){
                        echo "パスワードが違います。<br>";
                        fwrite($fp, $a."<>".$b."<>".$c."<>".$d."<>".$e."<>".PHP_EOL);  //パスワード2と新規作成のときのパスワードが違うときだけ、書き込む。
                    }
                }
                
                elseif($delete != $a){
                    fwrite($fp, $a."<>".$b."<>".$c."<>".$d."<>".$e."<>".PHP_EOL);  //削除対象番号と新規作成のときの投稿番号が違うときだけ、書き込む。
                }
            }
            
            fclose($fp);
        }
        
        elseif(empty($password2)){
            echo "パスワードを入力してください。<br>"; //この時は何も処理を行わないので、ファイルを空にしたりする作業しない。
        }
    }
    
        //画面表示
        
        if(file_exists($filename)){
        $lines = file($filename,FILE_IGNORE_NEW_LINES);
        foreach($lines as $line){
        $str = explode("<>", $line);
        echo $str[0]." ".$str[1]." ".$str[2]." ".$str[3]."<br>";   //画面にはパスワードは表示しない。
        }
    }
    
    ?>
    
</body>
</html>
